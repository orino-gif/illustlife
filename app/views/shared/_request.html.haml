- if @request

  - sender = User.find(@request.sender_id)
  - receiver = User.find(@request.receiver_id)
  
  / 表体を表示
  .row.my-5
    / 一覧表示の場合
    - if 'index' == controller.action_name
      / 表体のセルの幅の長さを「table全幅/セル数」にする
      %table.fixed_column
      
        %tr
          %td= "#{@request.created_at.strftime("%Y/%m/%d %H:%M")}"
          
          / 文字が一覧の表のセルをはみ出した場合に、はみ出した文字を隠す
          %td.hidden_overflow= display_icon(sender.creator,
            'size_small-square rounded-circle fit_cover') + sender.nickname
            
          %td.hidden_overflow= display_icon(receiver.creator,
            'size_small-square rounded-circle fit_cover') + receiver.nickname
            
          %td= "#{@request.status}"
          
          %td
            %button.btn.btn-light.font-medium
              = link_to '詳細', request_path(@request.id)
    - else 
      .col-md-auto
      
        %table.table
          %tr
            %td= "リクエストID：#{@request.id}"
          %tr
            %td= "申請日時：#{@request.created_at.strftime("%Y/%m/%d %H:%M")}"
            
          %tr
            - client_name = '依頼者：' + sender.nickname
            %td= display_icon(sender.creator,
              'size_small-square rounded-circle fit_cover') + client_name
          %tr
            - authorizer_name = '承認者：' + receiver.nickname
            %td= display_icon(receiver.creator,
              'size_small-square rounded-circle fit_cover') + authorizer_name
              
          %tr
            %td.string_indention-medium リクエスト内容：<br> #{@request.message}
            
          %tr
            %td= "ファイル形式：#{@request.file_format}"
            
          - if @request.is_anonymous?
            %tr
              %td= '非公開:有'
              
          - if @request.is_autographed?
            %tr
              %td= '宛名入りサイン:有'
              
          - if user_signed_in?
          
            /　このリクエストの関係者のみ以下を表示
            - party_to_the_request = false
            - if sender.id == current_user.id || receiver.id == current_user.id
              - party_to_the_request = true
            
            - if party_to_the_request || Rails.env.development?
              %tr
                %td= "金額：#{@request.money}円"
                
              %tr
                - working_days = receiver.creator.working_days * 60 * 60 * 24
                - deadline = @request.created_at + working_days
                %td.string_indention-medium
                  = "締め切り日：#{deadline.strftime('%Y/%m/%d %H:%M')}"
                  
              %tr
                %td= "状態：#{@request.status}"
                
      .col-sm-auto
        .string_indention-medium
          - if user_signed_in? && receiver.id == current_user.id
            - if '承認待ち' == @request.status
              = "#{sender.nickname}さんから"
              = "#{receiver.nickname}さんへのリクエストを承認しますか？"
              
              = button_to '承認', {controller:'requests', action:'show'},
                {method: :get, params:{status:'製作中', request_id:@request.id,
                amount:@request.money}}
                
              %br
                = button_to '拒否', {controller:'requests', action:'show'},
                {method: :get, params:{status:'拒否', request_id:@request.id}}
      
        - if '承認待ち' != @request.status
          - if @request.deliver_img?
            - if @request.deliver_img.to_s.include?('.psd')
              - pdf = Magick::ImageList.new(@request.deliver_img.to_s)
              - pdf[0].write("public/img/conversion_psd/#{current_user.id}_#{@request.id}.png")
              = link_to image_tag("/img/conversion_psd/#{current_user.id}_#{@request.id}.png",
                class:'size_large-rectangle fit_cover'),
                "img/conversion_psd/#{current_user.id}_#{@request.id}.png"
            - else
              = link_to image_tag(@request.deliver_img.url,
                class:'size_large-rectangle fit_cover'),
                @request.deliver_img.url
              %p.on_card SAMPLE
              
          - if user_signed_in?
            - if receiver.nickname == current_user.nickname
              - if '購入者クレジット不備によるキャンセル' != @request.status
              
                - if '納品完了' != @request.status
                
                  = form_with(model: @request, local: true) do |f|
                    = f.hidden_field :request_id, :value => @request.id
                    - if '拒否' == @request.status
                      = 'リクエストは拒否されました'
                      
                    - elsif '製作中断' == @request.status
                      = '製作が中断されました'
                      
                    - elsif @request.deliver_img.blank?
                      = '1枚目'
                      = f.file_field :deliver_img
                      = f.submit '登録'
                      
                    - else
                      = f.hidden_field :cancel, :value => 'キャンセル'
                      = f.submit '取り消し'
                
          - if @request.deliver_img2?
            %br
              %br= '2枚目'
              = link_to image_tag(@request.deliver_img2.url,
                class:'size_large-rectangle fit_cover'),
                @request.deliver_img2.url
              %p.on_card SAMPLE
                    
          - if (not @request.deliver_img.blank?) || @request.deliver_img2?
            - if user_signed_in?
              - if receiver.id == current_user.id
                - if '納品完了' != @request.status
                  = form_with(model: @request, local: true) do |f|
                    = f.hidden_field :request_id, :value => @request.id
                    - if @request.deliver_img2.blank?
                      %br= '2枚目'
                      = f.file_field :deliver_img2
                      = f.submit '登録'
                    - else
                      = f.hidden_field :cancel, :value => 'キャンセル2'
                      = f.submit '取り消し'
                  
          - if @request.deliver_img3?
            %br= '3枚目'
            = link_to image_tag(@request.deliver_img3.url,
              class:'size_large-rectangle fit_cover'), @request.deliver_img3.url
            %p.on_card SAMPLE
          
          - if (not @request.deliver_img2.blank?) || (@request.deliver_img3?)          
            - if (user_signed_in?) && (receiver.nickname == current_user.nickname) && ('納品完了' != @request.status)
              = form_with(model: @request, local: true) do |f|
                = f.hidden_field :request_id, :value => @request.id
                - if @request.deliver_img3.blank?
                  %br= '3枚目'
                  = f.file_field :deliver_img3
                  = f.submit '登録'
                - else
                  = f.hidden_field :cancel, :value => 'キャンセル3'
                  = f.submit '取り消し'
                  
          - if @request.deliver_img4?
            %br= '4枚目'
            = link_to image_tag(@request.deliver_img4.url,
              class:'size_large-rectangle fit_cover'), @request.deliver_img4.url
            %p.on_card SAMPLE
            
          - if (not @request.deliver_img3.blank?) || (@request.deliver_img4?)           
            - if (user_signed_in?) && (receiver.nickname == current_user.nickname) && ('納品完了' != @request.status)
              = form_with(model: @request, local: true) do |f|
                = f.hidden_field :request_id, :value => @request.id
                - if @request.deliver_img4.blank?
                  %br= '4枚目'
                  = f.file_field :deliver_img4
                  = f.submit '登録'
                - else
                  = f.hidden_field :cancel, :value => 'キャンセル4'
                  = f.submit '取り消し'
                  
          - if @request.deliver_img5?
            %br= '5枚目'
            = link_to image_tag(@request.deliver_img5.url,
              class:'size_large-rectangle fit_cover'), @request.deliver_img5.url
            %p.on_card SAMPLE
          
          - if (not @request.deliver_img4.blank?) || (@request.deliver_img5?)          
            - if (user_signed_in?) && (receiver.nickname == current_user.nickname) && ('納品完了' != @request.status)
              = form_with(model: @request, local: true) do |f|
                = f.hidden_field :request_id, :value => @request.id
                - if @request.deliver_img5.blank?
                  %br= '5枚目'
                  = f.file_field :deliver_img5
                  = f.submit '登録'
                - else
                  = f.hidden_field :cancel, :value => 'キャンセル5'
                  = f.submit '取り消し'
                  
          - if @request.deliver_img6?
            %br= '6枚目'
            = link_to image_tag(@request.deliver_img6.url,
              class:'size_large-rectangle fit_cover'), @request.deliver_img6.url
            %p.on_card SAMPLE
                    
          - if (not @request.deliver_img5.blank?) || (@request.deliver_img6?) 
            - if (user_signed_in?) && (receiver.nickname == current_user.nickname) && ('納品完了' != @request.status)
              = form_with(model: @request, local: true) do |f|
                = f.hidden_field :request_id, :value => @request.id
                - if @request.deliver_img6.blank?
                  %br= '6枚目'
                  = f.file_field :deliver_img6
                  = f.submit '登録'
                - else
                  = f.hidden_field :cancel, :value => 'キャンセル6'
                  = f.submit '取り消し'
      .col-sm-auto
        - if (user_signed_in?) && (receiver.nickname == current_user.nickname) && ('製作中' == @request.status || '手戻し' == @request.status)
          - if (@request.deliver_img?)
            = button_to '納品', {controller:'requests', action:'show'},
              {method: :get, params:{status:'納品完了', request_id:@request.id}}
          %br= button_to '製作中断', {controller:'requests', action:'show'},
            {method: :get, params:{status:'製作中断', request_id:@request.id}}
        - if (user_signed_in?) && ('納品完了' == @request.status)
          - if sender.nickname == current_user.nickname
            = button_to('ダウンロード',
              download_requests_path, {method: :get,params:{request_id: params[:id]}})
            - if @request.evaluation_comment.nil?
              = form_with(model: @request, local: true) do |f|
                .form-group.mt-4
                  = f.label :'コメント'
                  = f.text_area :evaluation_comment,
                    class:'form-control', size:'15x10'
                  = f.hidden_field :request_id, :value => @request.id
                = f.submit '送信', class:'btn btn-light'
          - elsif (user_signed_in?) && (receiver.nickname == current_user.nickname)
            = button_to '手戻し', {controller:'requests', action:'show'}, 
              {method: :get, params:{status:'手戻し', request_id:@request.id}}
      - if (user_signed_in?) && (nil != @request.evaluation_comment)
        %br=sender.nickname + "さんからコメント"
        %br=@request.evaluation_comment
